---
- hosts: k8s_master
  tasks:
    - name: Initializing Kubernetes on the master.
      become: yes
      shell: kubeadm init --ignore-preflight-errors=FileContent--proc-sys-net-bridge-bridge-nf-call-iptables,SystemVerification --pod-network-cidr=192.168.0.0/16

    - name: Creating a kube directory on the master for the config files.
      become: yes
      file: 
        path: $HOME/.kube
        state: directory

    - name: Copying the kube config to the kube directory.
      become: yes
      shell: cp -i /etc/kubernetes/admin.conf $HOME/.kube/config

    - name: Configuring RBAC for the Calico Pod Network.
      become: yes
      shell: kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml

    - name: Deploying the Calico Pod Network to Kubernetes.
      become: yes
      shell: kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml

    - name: Deploying an etcd instance to Kubernetes.
      become: yes
      shell: kubectl apply -f https://docs.projectcalico.org/v3.2/getting-started/kubernetes/installation/hosted/etcd.yaml

    - name: Retreiving the master discovery token.
      become: yes
      shell: kubeadm token list | awk '{print $1}' | sed -n 2p
      register: k8s_discovery_token

    - name: Retrieving the SHA256 hash for the discovery token.
      become: yes
      shell: openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null |    openssl dgst -sha256 -hex | sed 's/^.* //'
      register: k8s_discovery_token_hash

- hosts: k8s_nodes
  tasks:
    - name: Joining the nodes to the master.
      become: yes
      shell: kubeadm join --token {{ hostvars['pluto.sol.milkyway']['k8s_discovery_token']['stdout'] }} {{ k8s_master_ip }}:6443 --discovery-token-ca-cert-hash sha256:{{ hostvars['pluto.sol.milkyway']['k8s_discovery_token_hash']['stdout'] }} --ignore-preflight-errors=RequiredIPVSKernelModulesAvailable,FileContent--proc-sys-net-bridge-bridge-nf-call-iptables,SystemVerification